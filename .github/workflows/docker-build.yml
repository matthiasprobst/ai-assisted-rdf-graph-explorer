#name: Build and Push Docker Image
#
#on:
#  push:
#    branches: [ main, master, dev ]
#    tags: [ 'v*' ]
#  pull_request:
#    branches: [ main, master, dev ]
#  workflow_dispatch:
#    inputs:
#      environment:
#        description: 'Environment (development/production)'
#        required: true
#        default: 'development'
#        type: choice
#        options:
#          - development
#          - production
#
#env:
#  REGISTRY: ghcr.io
#  IMAGE_NAME: ${{ github.repository }}
#
#jobs:
#  test:
#    runs-on: ubuntu-latest
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#
#    - name: Setup Node.js
#      uses: actions/setup-node@v4
#      with:
#        node-version: '22'
#        cache: 'npm'
#
#    - name: Install dependencies
#      run: npm ci
#
#    - name: Run build test
#      run: npm run build
#
#    - name: Upload build artifacts
#      uses: actions/upload-artifact@v4
#      with:
#        name: build-artifacts
#        path: dist/
#        retention-days: 1
#
#  build-image:
#    needs: test
#    runs-on: ubuntu-latest
#    permissions:
#      contents: read
#      packages: write
#
#    strategy:
#      matrix:
#        environment:
#          - ${{ github.event.inputs.environment || 'development' }}
#
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#
#    - name: Set up Docker Buildx
#      uses: docker/setup-buildx-action@v3
#
#    - name: Log in to Container Registry
#      if: github.event_name != 'pull_request'
#      uses: docker/login-action@v3
#      with:
#        registry: ${{ env.REGISTRY }}
#        username: ${{ github.actor }}
#        password: ${{ secrets.GITHUB_TOKEN }}
#
#    - name: Extract metadata
#      id: meta
#      uses: docker/metadata-action@v5
#      with:
#        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
#        tags: |
#          type=ref,event=branch
#          type=ref,event=pr
#          type=semver,pattern={{version}}
#          type=semver,pattern={{major}}.{{minor}}
#          type=raw,value=latest,enable={{is_default_branch}}
#          type=raw,value=${{ matrix.environment }}
#
#    - name: Build and push Docker image
#      uses: docker/build-push-action@v5
#      with:
#        context: .
#        push: ${{ github.event_name != 'pull_request' }}
#        tags: ${{ steps.meta.outputs.tags }}
#        labels: ${{ steps.meta.outputs.labels }}
#        cache-from: type=gha
#        cache-to: type=gha,mode=max
#        platforms: linux/amd64,linux/arm64
#
#    - name: Generate SBOM
#      uses: anchore/sbom-action@v0
#      if: github.event_name != 'pull_request'
#      with:
#        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.environment }}
#        format: spdx-json
#        output-file: sbom-${{ matrix.environment }}.spdx.json
#
#    - name: Upload SBOM
#      uses: actions/upload-artifact@v4
#      if: github.event_name != 'pull_request'
#      with:
#        name: sbom-${{ matrix.environment }}
#        path: sbom-${{ matrix.environment }}.spdx.json
#        retention-days: 30
#
#  scan-image:
#    needs: build-image
#    runs-on: ubuntu-latest
#    if: github.event_name != 'pull_request'
#    steps:
#    - name: Run Trivy vulnerability scanner
#      uses: aquasecurity/trivy-action@master
#      with:
#        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
#        format: 'sarif'
#        output: 'trivy-results.sarif'
#
#    - name: Upload Trivy scan results
#      uses: github/codeql-action/upload-sarif@v3
#      if: always()
#      with:
#        sarif_file: 'trivy-results.sarif'
#
#  notify:
#    needs: [test, build-image, scan-image]
#    runs-on: ubuntu-latest
#    if: always()
#    steps:
#    - name: Workflow status
#      run: |
#        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build-image.result }}" = "success" ]; then
#          echo "✅ Workflow completed successfully!"
#        else
#          echo "❌ Workflow failed. Check the logs for details."
#          exit 1
#        fi